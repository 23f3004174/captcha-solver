<!DOCTYPE html>
<meta charset="utf-8">
<script>
/* This file defines a FastAPI app when executed with Python.
   It also serves a simple HTML UI at "/" for uploading a CAPTCHA image.

   If you're viewing this in a browser, you don't need to do anything here.
   To run the server:
     uvicorn index:app --reload
*/
</script>
<?python
# The below block is for illustration if an environment extracts Python from this file.
# If running as a .py file, everything after this line is valid Python.
?>
# FastAPI CAPTCHA solver using Tesseract OCR
import io
import os
from typing import Optional, Tuple

from fastapi import FastAPI, UploadFile, File, Form
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse, JSONResponse
from PIL import Image, ImageFilter, ImageOps
import pytesseract

app = FastAPI(title="CAPTCHA OCR Solver", version="1.0.0", docs_url="/docs", redoc_url="/redoc")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


INDEX_HTML = """
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CAPTCHA OCR Solver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
           margin: 0; padding: 0; background: #0b1020; color: #f0f4ff; }
    header { padding: 24px 16px; text-align: center; background: linear-gradient(135deg,#0b1020,#162447); }
    header h1 { margin: 0; font-size: 1.6rem; letter-spacing: .4px; }
    main { max-width: 980px; margin: 24px auto; padding: 16px; }
    .card { background: #101935; border: 1px solid #23315c; border-radius: 12px; padding: 16px; box-shadow: 0 8px 18px rgba(0,0,0,.35); }
    .row { display: flex; flex-wrap: wrap; gap: 16px; }
    .col { flex: 1 1 320px; min-width: 320px; }
    .dropzone {
      border: 2px dashed #3b4b87; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer;
      background: rgba(27, 40, 89, .35);
    }
    .dropzone:hover { background: rgba(27, 40, 89, .5); }
    input[type="file"] { display: none; }
    button { background: #2a62ff; color: white; border: none; border-radius: 10px; padding: 12px 16px; cursor: pointer; font-weight: 600; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    label { display: block; margin: 10px 0 6px; color: #c9d5ff; font-size: .95rem; }
    select, input[type="number"], input[type="text"] {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #2c3f77; background: #0d1733; color: #e6ecff;
    }
    .preview { background: #0d1733; border: 1px solid #23315c; border-radius: 12px; padding: 12px; }
    .preview img { max-width: 100%; max-height: 320px; display: block; margin: 0 auto; }
    .result { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
              background: #0d1733; border: 1px solid #23315c; border-radius: 12px; padding: 12px; }
    footer { text-align: center; font-size: .9rem; color: #97a5d8; margin-top: 16px; }
    .pill { display: inline-block; padding: 6px 10px; background: #152657; border: 1px solid #2b3d7a; border-radius: 999px; margin-right: 8px; font-size: .85rem; color: #cbd7ff; }
    .row-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .error { color: #ff8585; }
  </style>
</head>
<body>
  <header>
    <h1>CAPTCHA OCR Solver (FastAPI + Tesseract)</h1>
  </header>
  <main>
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Upload CAPTCHA image</label>
          <label class="dropzone" id="dropzone">
            <input id="file-input" type="file" accept="image/*" />
            <div id="dz-text">Click to select or drop an image here</div>
          </label>
          <div class="preview" id="preview" style="display:none;margin-top:12px;">
            <img id="preview-img" alt="Preview" />
          </div>
        </div>
        <div class="col">
          <div class="row-actions">
            <div class="pill">Endpoint: POST /solve</div>
            <div class="pill">Engine: Tesseract OCR</div>
          </div>
          <label for="preprocess">Preprocess</label>
          <select id="preprocess">
            <option value="auto">auto (recommended)</option>
            <option value="none">none</option>
            <option value="binary">binary threshold</option>
            <option value="median">median denoise</option>
            <option value="contrast">autocontrast</option>
          </select>

          <label for="psm" style="margin-top:8px;">Tesseract PSM (page segmentation mode)</label>
          <select id="psm">
            <option value="7">7 - single text line</option>
            <option value="8">8 - single word</option>
            <option value="6">6 - assume block of text</option>
            <option value="13">13 - raw line</option>
          </select>

          <label for="lang" style="margin-top:8px;">Language (optional)</label>
          <input id="lang" type="text" placeholder="e.g., eng (default), osd, deu, spa" />

          <div class="row-actions" style="margin-top:14px;">
            <button id="solve-btn" disabled>Solve CAPTCHA</button>
            <span id="status"></span>
          </div>
        </div>
      </div>

      <div style="margin-top:18px;">
        <label>Result</label>
        <div class="result" id="result">Upload an image and click "Solve CAPTCHA".</div>
      </div>
      <footer>
        Tip: If output is off, try a different PSM or preprocessing mode. Clear backgrounds and strong contrast help OCR.
      </footer>
    </div>
  </main>

  <script>
    const fileInput = document.getElementById('file-input');
    const dropzone = document.getElementById('dropzone');
    const solveBtn = document.getElementById('solve-btn');
    const statusSpan = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('preview-img');
    const preprocessSel = document.getElementById('preprocess');
    const psmSel = document.getElementById('psm');
    const langInput = document.getElementById('lang');

    function setStatus(text, isError=false) {
      statusSpan.textContent = text || '';
      statusSpan.className = isError ? 'error' : '';
    }

    function enableSolve(enabled) {
      solveBtn.disabled = !enabled;
    }

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.background = 'rgba(27, 40, 89, .6)'; });
    dropzone.addEventListener('dragleave', () => dropzone.style.background = 'rgba(27, 40, 89, .35)');
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.style.background = 'rgba(27, 40, 89, .35)';
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        fileInput.files = e.dataTransfer.files;
        onFileChosen();
      }
    });

    fileInput.addEventListener('change', onFileChosen);

    function onFileChosen() {
      const file = fileInput.files[0];
      if (!file) { enableSolve(false); return; }
      if (!file.type.startsWith('image/')) {
        setStatus('Please select an image file.', true);
        enableSolve(false);
        preview.style.display = 'none';
        return;
      }
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      preview.style.display = 'block';
      setStatus('');
      enableSolve(true);
    }

    solveBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return;
      setStatus('Solving...');
      enableSolve(false);

      const fd = new FormData();
      fd.append('image', file, file.name);
      fd.append('preprocess', preprocessSel.value);
      fd.append('psm', psmSel.value);
      const lang = (langInput.value || '').trim();
      if (lang) fd.append('lang', lang);

      try {
        const res = await fetch('/solve', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) {
          setStatus(data?.detail || 'Error', true);
          resultEl.textContent = JSON.stringify(data, null, 2);
        } else {
          setStatus('Done');
          resultEl.textContent = JSON.stringify(data, null, 2);
        }
      } catch (err) {
        console.error(err);
        setStatus('Network or server error.', true);
      } finally {
        enableSolve(true);
      }
    });
  </script>
</body>
</html>
"""

def _preprocess_image(img: Image.Image, mode: str) -> Image.Image:
    mode = (mode or "auto").lower()
    if mode == "none":
        return img
    # Ensure working in grayscale base for filtering/thresholding
    g = img.convert("L")

    if mode == "binary":
        # Simple fixed threshold
        return g.point(lambda x: 255 if x > 128 else 0, mode="1").convert("L")
    elif mode == "median":
        g2 = g.filter(ImageFilter.MedianFilter(size=3))
        return g2.point(lambda x: 255 if x > 140 else 0, mode="1").convert("L")
    elif mode == "contrast":
        return ImageOps.autocontrast(g, cutoff=2)
    elif mode == "auto":
        # Heuristic: autocontrast + median + adaptive-ish threshold
        g2 = ImageOps.autocontrast(g, cutoff=2)
        g3 = g2.filter(ImageFilter.MedianFilter(size=3))
        # Soft threshold based on histogram median
        hist = g3.histogram()
        total = sum(hist)
        cum = 0
        median_val = 128
        for i, c in enumerate(hist):
            cum += c
            if cum >= total / 2:
                median_val = i
                break
        thr = max(100, min(180, median_val))
        return g3.point(lambda x: 255 if x > thr else 0, mode="1").convert("L")
    else:
        return g

def _tesseract_available() -> Tuple[bool, Optional[str]]:
    try:
        v = pytesseract.get_tesseract_version()
        return True, str(v)
    except Exception as e:
        return False, str(e)

@app.get("/", response_class=HTMLResponse)
async def root():
    return INDEX_HTML

@app.post("/solve")
async def solve(
    image: UploadFile = File(..., description="Image file containing CAPTCHA"),
    preprocess: str = Form("auto"),
    psm: str = Form("7"),
    lang: Optional[str] = Form(None),
):
    ok, info = _tesseract_available()
    if not ok:
        return JSONResponse(
            status_code=500,
            content={"detail": "Tesseract engine not available. Please install tesseract-ocr.", "error": info},
        )

    try:
        content = await image.read()
        if not content:
            return JSONResponse(status_code=400, content={"detail": "Empty file."})
        img = Image.open(io.BytesIO(content))
        img.load()
    except Exception as e:
        return JSONResponse(status_code=400, content={"detail": f"Invalid image file: {str(e)}"})

    try:
        proc = _preprocess_image(img, preprocess)
        # Prepare tesseract options
        cfg = f"--psm {int(psm)} -c tessedit_do_invert=0"
        lang_opt = (lang or "eng").strip()

        text = pytesseract.image_to_string(proc, lang=lang_opt, config=cfg)
        text_clean = text.strip()

        data = pytesseract.image_to_data(proc, lang=lang_opt, config=cfg, output_type=pytesseract.Output.DICT)
        confs = [int(c) for c in data.get("conf", []) if str(c).isdigit() and int(c) >= 0]
        avg_conf = round(sum(confs) / len(confs), 2) if confs else None

        return {
            "text": text_clean,
            "avg_confidence": avg_conf,
            "psm": int(psm),
            "language": lang_opt,
            "preprocess": preprocess,
            "tesseract_version": info,
        }
    except Exception as e:
        return JSONResponse(status_code=500, content={"detail": f"OCR failed: {str(e)}"})

# Optional simple health check
@app.get("/health")
def health():
    ok, info = _tesseract_available()
    return {"status": "ok", "tesseract_available": ok, "tesseract_info": info}

# If this file is executed directly: run a dev server
if __name__ == "__main__":
    try:
        import uvicorn
        uvicorn.run("index:app", host="0.0.0.0", port=int(os.environ.get("PORT", "8000")), reload=True)
    except Exception as e:
        print("Failed to start server via uvicorn:", e)